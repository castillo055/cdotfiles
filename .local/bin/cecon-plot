#!/bin/bash

data="$(psql -U victor -d cecon -c 'SELECT date::timestamp,remaining FROM _out UNION ALL SELECT date::timestamp,remaining FROM _in;' | sed -r 's/.*remaining.*$//;s/-*//;s/\|.*\$//;s/,//' | sort -n )"

time { \
last=$(echo "$data" | tail -n1 | cut -c 2- )
i=2
data=$(while read line; do
	if [[ "$prevline" != "" ]]; then
		date1=${line% *}
		rem0=${prevline##* }
		echo -e "$prevline\n$date1 $rem0"
	fi
	prevline=$line
done < <(echo "$data") )
}
data=$( echo -e "$data\n$last" )
echo -e "$data"

echo "$data" | gnuplot -p -e ' set terminal png size 1920,1054 enhanced background rgb "#06060a";
set size ratio 0.5;
set border lw 3 lc rgb "#FCAE1E";
set xdata time;
set timefmt "%Y-%m-%d";
set xrange [ time(0) - 86400*30 : ];
set format x "%m/%d";
set timefmt "%Y-%m-%d %H:%M:%S";
set xtics 86400;
set ytics 50;
set grid;
set yrange [ 0 : ];
plot "/dev/stdin" using 1:3 with lines lt rgb "#FCAE1E";' > /tmp/cecon-plot_tmp.png

feh /tmp/cecon-plot_tmp.png

rm /tmp/cecon-plot_tmp.png
